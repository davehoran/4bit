<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4-Bit Computer Simulator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: #1a1a2e;
            color: #eee;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            color: #00ff88;
            margin-bottom: 20px;
            font-size: 2em;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
            margin-bottom: 20px;
        }

        .panel {
            background: #16213e;
            border: 2px solid #0f3460;
            border-radius: 8px;
            padding: 20px;
        }

        .panel h2 {
            color: #00ff88;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        /* Memory LED Matrix */
        .memory-display {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-top: 15px;
        }

        .memory-cell {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .memory-address {
            font-size: 0.7em;
            color: #888;
        }

        .led-nibble {
            display: flex;
            gap: 3px;
        }

        .led {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #2a2a3e;
            border: 1px solid #444;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.5);
            transition: all 0.2s;
        }

        .led.on {
            background: #00ff88;
            box-shadow: 0 0 10px #00ff88, 0 0 20px #00ff88, inset 0 0 5px #fff;
            border-color: #00ff88;
        }

        /* Registers */
        .registers {
            display: grid;
            gap: 10px;
        }

        .register {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #0f3460;
            border-radius: 4px;
        }

        .register-name {
            font-weight: bold;
            color: #00ff88;
        }

        .register-value {
            font-family: 'Courier New', monospace;
            color: #fff;
        }

        /* Code Editor */
        #code-editor {
            width: 100%;
            height: 300px;
            background: #0a0e1a;
            color: #00ff88;
            border: 1px solid #0f3460;
            border-radius: 4px;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            resize: vertical;
        }

        /* Controls */
        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        button {
            background: #0f3460;
            color: #00ff88;
            border: 2px solid #00ff88;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            transition: all 0.2s;
        }

        button:hover {
            background: #00ff88;
            color: #0f3460;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Output */
        .output {
            background: #0a0e1a;
            border: 1px solid #0f3460;
            border-radius: 4px;
            padding: 10px;
            height: 150px;
            overflow-y: auto;
            font-size: 0.9em;
        }

        .output-line {
            margin-bottom: 5px;
        }

        .error {
            color: #ff4444;
        }

        .success {
            color: #00ff88;
        }

        .info {
            color: #88ccff;
        }

        /* Speed Control */
        .speed-control {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        #speed-slider {
            flex: 1;
        }

        /* Documentation */
        .instruction-set {
            display: grid;
            gap: 10px;
            margin-top: 10px;
        }

        .instruction {
            background: #0f3460;
            padding: 10px;
            border-radius: 4px;
            border-left: 3px solid #00ff88;
        }

        .instruction-name {
            color: #00ff88;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .instruction-desc {
            font-size: 0.9em;
            color: #ccc;
        }

        .pc-highlight {
            border: 2px solid #ffaa00 !important;
            box-shadow: 0 0 10px #ffaa00;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üñ•Ô∏è 4-BIT COMPUTER SIMULATOR</h1>
        
        <div class="main-grid">
            <div>
                <div class="panel">
                    <h2>üìù Assembly Code</h2>
                    <textarea id="code-editor" spellcheck="false">; Sample Program: Count from 0 to 15
LDA 0      ; Load 0 into A
STA 15     ; Store at address 15

LOOP:
LDA 15     ; Load current value
ADD 1      ; Add 1
STA 15     ; Store back
JMP LOOP   ; Repeat forever</textarea>
                    <div class="controls">
                        <button onclick="assemble()">Assemble</button>
                        <button onclick="run()" id="run-btn">Run</button>
                        <button onclick="step()" id="step-btn">Step</button>
                        <button onclick="stop()" id="stop-btn">Stop</button>
                        <button onclick="reset()">Reset</button>
                    </div>
                    <div class="speed-control">
                        <label>Speed:</label>
                        <input type="range" id="speed-slider" min="1" max="1000" value="100">
                        <span id="speed-value">100 ms</span>
                    </div>
                </div>

                <div class="panel" style="margin-top: 20px;">
                    <h2>üí° Memory LED Matrix (16x4 bits)</h2>
                    <div class="memory-display" id="memory-display"></div>
                </div>
            </div>

            <div>
                <div class="panel">
                    <h2>üìä Registers</h2>
                    <div class="registers">
                        <div class="register">
                            <span class="register-name">A (Accumulator)</span>
                            <span class="register-value" id="reg-a">0000</span>
                        </div>
                        <div class="register">
                            <span class="register-name">PC (Program Counter)</span>
                            <span class="register-value" id="reg-pc">0000</span>
                        </div>
                        <div class="register">
                            <span class="register-name">Zero Flag</span>
                            <span class="register-value" id="flag-z">0</span>
                        </div>
                        <div class="register">
                            <span class="register-name">Carry Flag</span>
                            <span class="register-value" id="flag-c">0</span>
                        </div>
                    </div>
                </div>

                <div class="panel" style="margin-top: 20px;">
                    <h2>üì∫ Output Console</h2>
                    <div class="output" id="output"></div>
                </div>
            </div>
        </div>

        <div class="panel">
            <h2>üìñ Instruction Set Architecture (ISA)</h2>
            <div class="instruction-set">
                <div class="instruction">
                    <div class="instruction-name">LDA addr - Load Accumulator</div>
                    <div class="instruction-desc">Loads the 4-bit value from memory address into the accumulator. A = MEM[addr]</div>
                </div>
                <div class="instruction">
                    <div class="instruction-name">STA addr - Store Accumulator</div>
                    <div class="instruction-desc">Stores the accumulator value into memory address. MEM[addr] = A</div>
                </div>
                <div class="instruction">
                    <div class="instruction-name">ADD addr - Add</div>
                    <div class="instruction-desc">Adds the value at memory address to accumulator. A = A + MEM[addr]. Sets carry flag on overflow.</div>
                </div>
                <div class="instruction">
                    <div class="instruction-name">SUB addr - Subtract</div>
                    <div class="instruction-desc">Subtracts the value at memory address from accumulator. A = A - MEM[addr]. Sets carry on underflow.</div>
                </div>
                <div class="instruction">
                    <div class="instruction-name">JMP addr - Jump</div>
                    <div class="instruction-desc">Unconditional jump to address. PC = addr</div>
                </div>
                <div class="instruction">
                    <div class="instruction-name">JZ addr - Jump if Zero</div>
                    <div class="instruction-desc">Jump to address if zero flag is set. If Z=1 then PC = addr</div>
                </div>
                <div class="instruction">
                    <div class="instruction-name">JC addr - Jump if Carry</div>
                    <div class="instruction-desc">Jump to address if carry flag is set. If C=1 then PC = addr</div>
                </div>
                <div class="instruction">
                    <div class="instruction-name">OUT - Output</div>
                    <div class="instruction-desc">Outputs the accumulator value to the console</div>
                </div>
                <div class="instruction">
                    <div class="instruction-name">HLT - Halt</div>
                    <div class="instruction-desc">Stops program execution</div>
                </div>
                <div class="instruction">
                    <div class="instruction-name">NOP - No Operation</div>
                    <div class="instruction-desc">Does nothing, advances to next instruction</div>
                </div>
            </div>
            <div style="margin-top: 15px; padding: 10px; background: #0f3460; border-radius: 4px;">
                <strong style="color: #00ff88;">Notes:</strong>
                <ul style="margin-left: 20px; margin-top: 5px; color: #ccc;">
                    <li>All values are 4-bit (0-15)</li>
                    <li>Memory addresses are 4-bit (0-15)</li>
                    <li>Labels can be used instead of addresses</li>
                    <li>Comments start with semicolon (;)</li>
                    <li>Instructions are case-insensitive</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // 4-Bit Computer State
        let memory = new Array(16).fill(0);
        let accumulator = 0;
        let programCounter = 0;
        let zeroFlag = 0;
        let carryFlag = 0;
        let running = false;
        let program = [];
        let labels = {};
        let speed = 100;
        let runInterval = null;

        // Instruction opcodes
        const OPCODES = {
            'LDA': 0x1,
            'STA': 0x2,
            'ADD': 0x3,
            'SUB': 0x4,
            'JMP': 0x5,
            'JZ': 0x6,
            'JC': 0x7,
            'OUT': 0x8,
            'HLT': 0x9,
            'NOP': 0x0
        };

        // Initialize LED matrix
        function initLEDMatrix() {
            const display = document.getElementById('memory-display');
            display.innerHTML = '';
            
            for (let addr = 0; addr < 16; addr++) {
                const cell = document.createElement('div');
                cell.className = 'memory-cell';
                cell.id = `mem-cell-${addr}`;
                
                const addrLabel = document.createElement('div');
                addrLabel.className = 'memory-address';
                addrLabel.textContent = `[${addr}]`;
                
                const nibble = document.createElement('div');
                nibble.className = 'led-nibble';
                
                for (let bit = 3; bit >= 0; bit--) {
                    const led = document.createElement('div');
                    led.className = 'led';
                    led.id = `led-${addr}-${bit}`;
                    nibble.appendChild(led);
                }
                
                cell.appendChild(addrLabel);
                cell.appendChild(nibble);
                display.appendChild(cell);
            }
        }

        // Update LED display
        function updateLEDs() {
            for (let addr = 0; addr < 16; addr++) {
                const value = memory[addr] & 0xF;
                for (let bit = 0; bit < 4; bit++) {
                    const led = document.getElementById(`led-${addr}-${bit}`);
                    if (value & (1 << bit)) {
                        led.classList.add('on');
                    } else {
                        led.classList.remove('on');
                    }
                }
                
                // Highlight PC location
                const cell = document.getElementById(`mem-cell-${addr}`);
                if (addr === programCounter) {
                    cell.classList.add('pc-highlight');
                } else {
                    cell.classList.remove('pc-highlight');
                }
            }
        }

        // Update register display
        function updateRegisters() {
            document.getElementById('reg-a').textContent = accumulator.toString(2).padStart(4, '0');
            document.getElementById('reg-pc').textContent = programCounter.toString(2).padStart(4, '0');
            document.getElementById('flag-z').textContent = zeroFlag;
            document.getElementById('flag-c').textContent = carryFlag;
        }

        // Log to output
        function log(message, type = 'info') {
            const output = document.getElementById('output');
            const line = document.createElement('div');
            line.className = `output-line ${type}`;
            line.textContent = message;
            output.appendChild(line);
            output.scrollTop = output.scrollHeight;
        }

        // Clear output
        function clearOutput() {
            document.getElementById('output').innerHTML = '';
        }

        // Assembler
        function assemble() {
            clearOutput();
            const code = document.getElementById('code-editor').value;
            const lines = code.split('\n');
            
            program = [];
            labels = {};
            let address = 0;
            
            // First pass: collect labels
            for (let line of lines) {
                line = line.trim();
                if (line === '' || line.startsWith(';')) continue;
                
                if (line.includes(':')) {
                    const labelName = line.split(':')[0].trim();
                    labels[labelName] = address;
                    continue;
                }
                
                address++;
            }
            
            // Second pass: assemble instructions
            for (let line of lines) {
                line = line.trim();
                if (line === '' || line.startsWith(';')) continue;
                if (line.includes(':')) continue;
                
                // Remove comments
                if (line.includes(';')) {
                    line = line.split(';')[0].trim();
                }
                
                const parts = line.split(/\s+/);
                const instruction = parts[0].toUpperCase();
                
                if (!OPCODES.hasOwnProperty(instruction)) {
                    log(`Error: Unknown instruction '${instruction}'`, 'error');
                    return false;
                }
                
                let operand = 0;
                if (parts.length > 1) {
                    const param = parts[1];
                    if (labels.hasOwnProperty(param)) {
                        operand = labels[param];
                    } else {
                        operand = parseInt(param) & 0xF;
                    }
                }
                
                program.push({ opcode: OPCODES[instruction], operand: operand, line: line });
            }
            
            // Load program into memory
            for (let i = 0; i < program.length && i < 16; i++) {
                memory[i] = (program[i].opcode << 4) | program[i].operand;
            }
            
            log(`Assembly successful! ${program.length} instructions loaded.`, 'success');
            updateLEDs();
            updateRegisters();
            return true;
        }

        // Execute one instruction
        function executeInstruction() {
            if (programCounter >= 16) {
                log('Program counter out of bounds!', 'error');
                stop();
                return false;
            }
            
            const instruction = memory[programCounter];
            const opcode = (instruction >> 4) & 0xF;
            const operand = instruction & 0xF;
            
            let halt = false;
            
            switch (opcode) {
                case OPCODES.LDA:
                    accumulator = memory[operand] & 0xF;
                    zeroFlag = (accumulator === 0) ? 1 : 0;
                    log(`LDA [${operand}] -> A=${accumulator}`);
                    break;
                    
                case OPCODES.STA:
                    memory[operand] = accumulator & 0xF;
                    log(`STA [${operand}] <- A=${accumulator}`);
                    break;
                    
                case OPCODES.ADD:
                    const addResult = accumulator + (memory[operand] & 0xF);
                    carryFlag = (addResult > 15) ? 1 : 0;
                    accumulator = addResult & 0xF;
                    zeroFlag = (accumulator === 0) ? 1 : 0;
                    log(`ADD [${operand}] -> A=${accumulator} C=${carryFlag}`);
                    break;
                    
                case OPCODES.SUB:
                    const subResult = accumulator - (memory[operand] & 0xF);
                    carryFlag = (subResult < 0) ? 1 : 0;
                    accumulator = (subResult + 16) & 0xF;
                    zeroFlag = (accumulator === 0) ? 1 : 0;
                    log(`SUB [${operand}] -> A=${accumulator} C=${carryFlag}`);
                    break;
                    
                case OPCODES.JMP:
                    programCounter = operand;
                    log(`JMP -> PC=${programCounter}`);
                    updateLEDs();
                    updateRegisters();
                    return true;
                    
                case OPCODES.JZ:
                    if (zeroFlag === 1) {
                        programCounter = operand;
                        log(`JZ (taken) -> PC=${programCounter}`);
                        updateLEDs();
                        updateRegisters();
                        return true;
                    } else {
                        log(`JZ (not taken)`);
                    }
                    break;
                    
                case OPCODES.JC:
                    if (carryFlag === 1) {
                        programCounter = operand;
                        log(`JC (taken) -> PC=${programCounter}`);
                        updateLEDs();
                        updateRegisters();
                        return true;
                    } else {
                        log(`JC (not taken)`);
                    }
                    break;
                    
                case OPCODES.OUT:
                    log(`OUTPUT: ${accumulator} (0b${accumulator.toString(2).padStart(4, '0')})`, 'success');
                    break;
                    
                case OPCODES.HLT:
                    log('HALT - Program stopped', 'success');
                    halt = true;
                    break;
                    
                case OPCODES.NOP:
                    log('NOP');
                    break;
                    
                default:
                    log(`Unknown opcode: ${opcode}`, 'error');
                    halt = true;
            }
            
            if (!halt) {
                programCounter = (programCounter + 1) & 0xF;
            } else {
                stop();
                return false;
            }
            
            updateLEDs();
            updateRegisters();
            return true;
        }

        // Run program
        function run() {
            if (!program.length) {
                log('Please assemble code first!', 'error');
                return;
            }
            
            running = true;
            document.getElementById('run-btn').disabled = true;
            document.getElementById('step-btn').disabled = true;
            
            runInterval = setInterval(() => {
                if (!executeInstruction()) {
                    stop();
                }
            }, speed);
        }

        // Step one instruction
        function step() {
            if (!program.length) {
                log('Please assemble code first!', 'error');
                return;
            }
            
            executeInstruction();
        }

        // Stop execution
        function stop() {
            running = false;
            if (runInterval) {
                clearInterval(runInterval);
                runInterval = null;
            }
            document.getElementById('run-btn').disabled = false;
            document.getElementById('step-btn').disabled = false;
        }

        // Reset computer
        function reset() {
            stop();
            memory.fill(0);
            accumulator = 0;
            programCounter = 0;
            zeroFlag = 0;
            carryFlag = 0;
            clearOutput();
            updateLEDs();
            updateRegisters();
            log('Computer reset', 'info');
        }

        // Speed slider
        document.getElementById('speed-slider').addEventListener('input', (e) => {
            speed = parseInt(e.target.value);
            document.getElementById('speed-value').textContent = `${speed} ms`;
            
            if (running) {
                stop();
                run();
            }
        });

        // Initialize
        initLEDMatrix();
        updateLEDs();
        updateRegisters();
        log('4-Bit Computer ready. Write your code and click Assemble!', 'success');
    </script>
</body>
</html>